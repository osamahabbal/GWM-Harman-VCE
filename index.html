<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haval Jolion Config Editor</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --text: #212529;
            --desc-color: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            margin: 0;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .lang-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        textarea {
            width: 100%;
            height: 80px;
            font-family: "Courier New", monospace;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .control-item {
            background: #fff;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .param-label {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9em;
        }

        .param-desc {
            display: block;
            font-size: 0.85em;
            color: var(--desc-color);
            margin-bottom: 5px;
            min-height: 1.2em;
            line-height: 1.3;
        }

        .meta {
            font-size: 0.7em;
            color: #adb5bd;
            white-space: nowrap;
        }

        .control-item input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .stats {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        html[dir="ltr"] .stats { text-align: right; }
        html[dir="rtl"] .stats { text-align: left; }
        html[dir="rtl"] .control-header { flex-direction: row-reverse; }
        html[dir="rtl"] #searchBox { text-align: right; }

        .error { color: #dc3545; font-size: 0.9rem; margin-top: 5px; display: none; }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }
        .footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body dir="ltr">

<div class="container">
    <div class="header">
        <h1 data-i18n="title">Haval Jolion Config Editor</h1>
        <select class="lang-select" id="langSwitcher" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="ru">Русский</option>
            <option value="ar">العربية</option>
        </select>
    </div>

    <div class="card">
        <label for="inputHex" data-i18n="lbl_input">Original Configuration String (Paste from Scanner)</label>
        <textarea id="inputHex" placeholder="A1 04 5F ..."></textarea>
        <div class="stats"><span data-i18n="lbl_length">Length</span>: <span id="inputLen">0</span> <span data-i18n="lbl_chars">chars</span></div>
        <div id="errorMsg" class="error"></div>
        <button onclick="loadConfig()" data-i18n="btn_load">Load & Parse Settings</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap: wrap; gap:10px;">
            <label data-i18n="lbl_params" style="margin: auto 0;">Parameters</label>
            <input type="text" id="searchBox" placeholder="Search parameters..." style="padding:5px; border:1px solid #ddd; border-radius:4px; flex-grow: 1; max-width: 300px;" onkeyup="filterParams()">
        </div>
        <div id="editorGrid" class="grid-container">
            <div id="instructionText" style="color: #888; grid-column: 1/-1; text-align: center; padding: 20px;" data-i18n="msg_instruction">
                Paste a hex string above and click "Load" to begin.
            </div>
        </div>
    </div>

    <div class="card">
        <label for="outputHex" data-i18n="lbl_output">New Configuration String</label>
        <textarea id="outputHex" readonly></textarea>
        <div class="stats"><span data-i18n="lbl_length">Length</span>: <span id="outputLen">0</span> <span data-i18n="lbl_chars">chars</span></div>
        <button onclick="copyOutput()" class="secondary" data-i18n="btn_copy">Copy to Clipboard</button>
    </div>

    <div class="footer">
        <span data-i18n="credit_script">Original vce.py script by</span> <a href="https://t.me/DymOK" target="_blank">Dimitry (DymOK)</a>
        <br>
        <span data-i18n="credit_site">Web Interface by</span> <a href="https://t.me/ossaamaaa" target="_blank">Osama</a>
    </div>
</div>

<script>
    const translations = {
        en: {
            title: "Haval Jolion Config Editor",
            lbl_input: "Original Configuration String (From Scanner)",
            lbl_length: "Length",
            lbl_chars: "chars",
            btn_load: "Load & Parse Settings",
            lbl_params: "Parameters",
            search_placeholder: "Search parameters...",
            msg_instruction: "Paste a hex string above and click 'Load' to begin.",
            lbl_output: "New Configuration String",
            btn_copy: "Copy to Clipboard",
            btn_copied: "Copied!",
            error_short: "Error: String is too short.",
            credit_script: "Original vce.py script by",
            credit_site: "Web Interface by"
        },
        ru: {
            title: "Редактор Конфигурации Haval Jolion",
            lbl_input: "Исходная строка конфигурации (из сканера)",
            lbl_length: "Длина",
            lbl_chars: "симв.",
            btn_load: "Загрузить настройки",
            lbl_params: "Параметры",
            search_placeholder: "Поиск параметров...",
            msg_instruction: "Вставьте hex строку выше и нажмите 'Загрузить'.",
            lbl_output: "Новая строка конфигурации",
            btn_copy: "Копировать",
            btn_copied: "Скопировано!",
            error_short: "Ошибка: Строка слишком короткая.",
            credit_script: "Оригинальный скрипт vce.py от",
            credit_site: "Веб-интерфейс от"
        },
        ar: {
            title: "محرر إعدادات هافال جوليون",
            lbl_input: "نص التكوين الأصلي (من الماسح الضوئي)",
            lbl_length: "الطول",
            lbl_chars: "حرف",
            btn_load: "تحميل الإعدادات",
            lbl_params: "الإعدادات",
            search_placeholder: "بحث عن إعداد...",
            msg_instruction: "ضع النص أعلاه ثم اضغط على 'تحميل الإعدادات' للبدء.",
            lbl_output: "نص التكوين الجديد",
            btn_copy: "نسخ النص",
            btn_copied: "تم النسخ!",
            error_short: "خطأ: النص قصير جداً.",
            credit_script: "سكربت vce.py الأصلي بواسطة",
            credit_site: "واجهة الموقع بواسطة"
        }
    };

    const paramDesc = {
        "AAA": { en: "PROJECT CODE", ru: "КОД ПРОЕКТА" },
        "PAS": { en: "SEAT HEATING", ru: "ПОДОГРЕВ СИДЕНИЙ" },
        "VAA": { en: "AUDIO+VIDEO SYSTEM", ru: "АУДИО+ВИДЕО СИСТЕМА" },
        "TBV": { en: "TRAFFIC SIGN WARNING", ru: "ПРЕДУПРЕЖДАЮЩИЙ ДОРОЖНЫЙ ЗНАК" },
        "DAA": { en: "FUEL", ru: "ТОПЛИВО" },
        "EAA": { en: "TRANSMISSION", ru: "ПЕРЕДАЧА ИНФЕКЦИИ" },
        "CAL": { en: "IDLE STOP AND GO", ru: "ХОЛОСТОЙ СТОП И ИДТИ" },
        "AAC": { en: "REGIONAL", ru: "РЕГИОНАЛЬНЫЙ" },
        "BAA": { en: "DRIVE HANDLE TYPE", ru: "ТИП ПРИВОДНОЙ РУЧКИ" },
        "KAG": { en: "OUTSIDE RR VIEW MIRROR", ru: "ВНЕШНЕЕ ЗЕРКАЛО ОБЗОРА" },
        "ZE0": { en: "SALES AREA", ru: "ТОРГОВАЯ ЗОНА" },
        "PAA": { en: "DRIVER SEAT", ru: "СИДЕНЬЕ ВОДИТЕЛЯ" },
        "KAJ": { en: "FRT DEAD ANGLE SYSTEM", ru: "СИСТЕМА МЕРТВОГО УГЛА FRT" },
        "TAA": { en: "REVERSE VIDEO", ru: "ОБРАТНОЕ ВИДЕО" },
        "PAT": { en: "FRT SEAT COOLING+MASSAGE", ru: "ОХЛАЖДЕНИЕ+МАССАЖ ПЕРЕДНЕГО СИДЕНЬЯ" },
        "SAF": { en: "HEAD LAMP AUTO OFF", ru: "ФАРЫ АВТО ВЫКЛ." },
        "SAA": { en: "HEAD LAMP ADJUSTMENT", ru: "РЕГУЛИРОВКА ФАР" },
        "RAB": { en: "CLUSTER", ru: "КЛАСТЕР" },
        "TAT": { en: "COLLISION WARNING+AEB", ru: "ПРЕДУПРЕЖДЕНИЕ О СТОЛКНОВЕНИИ+AEB" },
        "SAQ": { en: "MOOD LAMP", ru: "ЛАМПА НАСТРОЕНИЯ" },
        "TAU": { en: "STARTING SYSTEM", ru: "СИСТЕМА ЗАПУСКА" },
        "TAB": { en: "AUTO PARKING SYSTEM", ru: "СИСТЕМА АВТОПАРКОВКИ" },
        "TAS": { en: "DROWSINESS WARNING", ru: "СИСТЕМА ПРЕДУПРЕЖДЕНИЯ СОНЛИВОСТИ" },
        "TAQ": { en: "LDW+LKA", ru: "ЛДВ+ЛКА" },
        "TBK": { en: "DR OPEN WARNING", ru: "ПРЕДУПРЕЖДЕНИЕ DR ОТКРЫТО" },
        "TBA": { en: "OMNIVIEW SYSTEM", ru: "СИСТЕМА ОМНИВЬЮ" },
        "UAC": { en: "AIR QUALITY SYSTEM", ru: "СИСТЕМА КАЧЕСТВА ВОЗДУХА" },
        "UAB": { en: "AIR CONDITIONER", ru: "КОНДИЦИОНЕР ВОЗДУХА" },
        "VAQ": { en: "HMI", ru: "ВЗАИМОДЕЙСТВИЕ ЧЕЛОВЕКА С КОМПЬЮТЕРОМ" },
        "VAM": { en: "VOICE RECOGNITION", ru: "РАСПОЗНАВАНИЕ ГОЛОСА" },
        "VAL": { en: "TELEMATICS", ru: "ТЕЛЕМАТИКА" },
        "TAR": { en: "LANE CHANGE ASSIST", ru: "Ассистент смены полосы движения" },
        "VAR": { en: "ELECTRIC SOUND REMINDER", ru: "ЭЛЕКТРИЧЕСКОЕ ЗВУКОВОЕ НАПОМИНАНИЕ" },
        "TBU": { en: "REMOTE RESERVATION CHARGING", ru: "ДИСТАНЦИОННАЯ ОПЛАТА БРОНИРОВАНИЯ" },
        "ZF4": { en: "LANE SUPPORT HAPTIC", ru: "ТАКТИЧЕСКОЕ НАПОМИНАНИЕ ПОЛОСЫ" },
        "TBR": { en: "VOICE & FACIAL RECOGNITION", ru: "РАСПОЗНАВАНИЕ ГОЛОСА И ЛИЦА" },
        "PAP": { en: "PASS WAIST SUPPORTER", ru: "ПОДДЕРЖКА ПОЯСНОСТИ" },
        "VAJ": { en: "NAVIGATION", ru: "НАВИГАЦИЯ" },
        "TBW": { en: "REAR COLLISION WARNING", ru: "ПРЕДУПРЕЖДЕНИЕ ЗАДНЕГО СТОЛКНОВЕНИЯ" },
        "HAJ": { en: "BRAKING ENERGY RECOVERY", ru: "РЕКУПЕРАЦИЯ ЭНЕРГИИ ТОРМОЖЕНИЯ" },
        "PAE": { en: "DRIVER WAIST SUPPORTER", ru: "ПОДДЕРЖКА ПОЯСНОСТИ ВОДИТЕЛЯ" },
        "LAA": { en: "DECK", ru: "ПАЛУБА" },
        "VAF": { en: "SPEAKER", ru: "ДИНАМИК" },
        "ZA3": { en: "FRONT SENSOR", ru: "ПЕРЕДНИЙ ДАТЧИК" },
        "ZA2": { en: "REAR PAS SENSOR", ru: "ЗАДНИЙ ДАТЧИК PAS" },
        "TAW": { en: "BLUETOOTH", ru: "BLUETOOTH" },
        "KAQ": { en: "RR DOOR OPENING", ru: "ОТКРЫТИЕ ЗАДНЕЙ ДВЕРИ" },
        "TAM": { en: "PAS+CTA", ru: "PAS+CTA" },
        "UAH": { en: "FRAGRANCE SYSTEM", ru: "АРОМАТИЧЕСКАЯ СИСТЕМА" },
        "NAF": { en: "AIR PURIFIER", ru: "ОЧИСТИТЕЛЬ ВОЗДУХА" },
        "ZC2": { en: "SEAT CONTROL MODULE", ru: "МОДУЛЬ УПРАВЛЕНИЯ СИДЕНЬЕМ" },
        "TCR": { en: "REMOTE CONTROL", ru: "ДИСТАНЦИОННОЕ УПРАВЛЕНИЕ" },
        "ZA0": { en: "DOOR UNLOCK MODE", ru: "РЕЖИМ РАЗБЛОКИРОВКИ ДВЕРИ" },
        "RAE": { en: "OFF-ROAD INFO DISPLAY", ru: "ИНФОРМАЦИОННЫЙ ДИСПЛЕЙ ДЛЯ ВНЕДОРОЖНОСТИ" },
        "ZB3": { en: "DEFAULT TEMP UNIT", ru: "ЕДИНИЦА ТЕМПЕРАТУРЫ ПО УМОЛЧАНИЮ" },
        "ZF5": { en: "ENHANCED ASSIST HAPTIC", ru: "ТАКТИЧЕСКОЕ НАПОМИНАНИЕ РАСШ. СИСТЕМ" },
        "VAG": { en: "AMPLIFIER", ru: "УСИЛИТЕЛЬ" },
        "KAT": { en: "TRAILING HOOK", ru: "ПРОДВИЖНОЙ КРЮК" },
        "ZE2": { en: "INTELLIGENT NETWORK SERVICE", ru: "ИНТЕЛЛЕКТУАЛЬНЫЙ СЕТЕВОЙ СЕРВИС" },
        "TBG": { en: "VIDEO DATA RECORDER", ru: "РЕГИСТРАТОР ВИДЕОДАННЫХ" },
        "FAA": { en: "STEERING SYSTEM", ru: "СИСТЕМА РУЛЕВОГО УПРАВЛЕНИЯ" },
        "CBC": { en: "OFF-ROAD CRUISE CONTROL", ru: "ВНЕДОРОЖНЫЙ КРУИЗ-КОНТРОЛЬ" },
        "ZA5": { en: "DRIVING MODE OPTIONAL", ru: "РЕЖИМ ВОЖДЕНИЯ ДОПОЛНИТЕЛЬНО" },
        "ZB6": { en: "PARKING LAMP", ru: "СТОЯНОЧНАЯ ФОНАРЬ" },
        "ZB7": { en: "OMNIVIEW CONFIG INFO", ru: "СИСТЕМА OMNIVIEW (ИНФОРМАЦИЯ)" },
        "HAE": { en: "PARKING BRAKE", ru: "СТОЯНОЧНЫЙ ТОРМОЗ" },
        "TBQ": { en: "HEAD UP DISPLAY", ru: "ПРОЕКЦИОННЫЙ ДИСПЛЕЙ" },
        "UAG": { en: "INDOOR AUTO DEMISTING", ru: "АВТОМАТИЧЕСКОЕ ТУМОУВЛАЖНЕНИЕ" },
        "TBH": { en: "WIRELESS CHARGER", ru: "БЕСПРОВОДНОЕ ЗАРЯДНОЕ УСТРОЙСТВО" },
        "TCD": { en: "FRONT CROSS WARNING+BREAK", ru: "ПЕРЕДНЕЕ КРЕСТОВОЕ ПРЕДУПРЕЖДЕНИЕ" },
        "MAE": { en: "DRIVER WINDOW OPERATING", ru: "ОКНО ВОДИТЕЛЯ РАБОТАЕТ" },
        "SAK": { en: "AUTO LIGHT SYSTEM", ru: "СИСТЕМА АВТОСВЕТА" },
        "TCE": { en: "AEB JUNCTION ASSIST", ru: "AEB JUNCTION ASSIST" },
        "BAF": { en: "SPECIAL COUNTRY(EXPORT)", ru: "СПЕЦИАЛЬНАЯ СТРАНА(ЭКСПОРТ)" },
        "TAY": { en: "SUPER LOCK", ru: "СУПЕР ЗАМОК" },
        "KAN": { en: "SIDE STEP", ru: "БОКОВОЙ ШАГ" },
        "TCF": { en: "AUTO EVASIVE STEERING", ru: "АВТО УКЛОНЯЮЩЕЕ РУЛЕВОЕ УПРАВЛЕНИЕ" },
        "ZG3": { en: "MEMORY OF DRIVING MODE", ru: "ПАМЯТЬ РЕЖИМА ВОЖДЕНИЯ" },
        "ZG2": { en: "DRIVING MODE 2", ru: "РЕЖИМ ВОЖДЕНИЯ 2" },
        "MAG": { en: "RR 1ST WINDOW OPERATING", ru: "RR 1-ОЕ ОКНО РАБОТАЕТ" },
        "MAF": { en: "PASSENGER WINDOW OPERATING", ru: "ОКНО ПАССАЖИРСКОГО ОКНА В РАБОТЕ" },
        "EAM": { en: "E-PARK", ru: "Е-ПАРК" },
        "ZF6": { en: "SMART START STOP MEMORY", ru: "УМНЫЙ ПЕРЕКЛЮЧАТЕЛЬ СТАРТ-СТОП" },
        "ZC3": { en: "SUN ROOF CONTROLLER", ru: "КОНТРОЛЛЕР ЛЮКА НА КРЫШЕ" },
        "ZH1": { en: "BATTERY TEMP KEEP", ru: "ПОДДЕРЖИВАНИЕ ТЕМПЕРАТУРЫ АКБ" },
        "TCP": { en: "EMERGENCY STEERING SUPPORT", ru: "АВАРИЙНАЯ РУЛЕВАЯ ПОДДЕРЖКА" },
        "ZH3": { en: "BATTERY SENSOR", ru: "ДАТЧИК АККУМУЛЯТОРА" },
        "KAU": { en: "RADIATOR GRILLE", ru: "РЕШЕТКА РАДИАТОРА" },
        "EAN": { en: "OFF-ROAD EXPERT MODE", ru: "ЭКСПЕРТНЫЙ РЕЖИМ ВНЕДОРОЖЬЯ" },
        "MAK": { en: "FR WINDSHIELD HEAT NOZZLE", ru: "НАСАДКА ОБОГРЕВА ВЕТРОВОГО СТЕКЛА" },
        "TDE": { en: "ACTIVE ACCESS SYSTEM", ru: "СИСТЕМА АКТИВНОГО ДОСТУПА" },
        "PAB": { en: "PASSENGER SEAT", ru: "ПАССАЖИРСКОЕ СИДЕНЬЕ" },
        "HAQ": { en: "DYNAMIC STEERING TORQUE", ru: "ДИНАМИЧЕСКИЙ РУЛЕВОЙ МОМЕНТ" },
        "FAD": { en: "STEERING HEATING", ru: "ПОДОГРЕВ РУЛЕВОГО УПРАВЛЕНИЯ" },
        "ZM2": { en: "SEAT MEMORY TYPE", ru: "ТИП С ПАМЯТЬЮ СИДЕНЬЯ" },
        "TAN": { en: "FRONT WIPER SYSTEM", ru: "СИСТЕМА ПЕРЕДНЕГО СТЕКЛООЧИСТИТЕЛЯ" },
        "MAL": { en: "WINDSHIELD HEATING", ru: "ОБОГРЕВ ЛОБОВОГО" },
        "ZJ9": { en: "DVR", ru: "Видеорегистратор" },
        "ZE4": { en: "SMART JUNCTION BOX", ru: "УМНАЯ РАСПРЕДЕЛИТЕЛЬНАЯ КОРОБКА" },
        "AAE": { en: "POWER TRAIN TYPE", ru: "ТИП СИЛОВОЙ ПЕРЕДАЧИ" },
        "PBW": { en: "PASSENGER SEAT MASSAGE", ru: "МАССАЖ ПАССАЖИРСКОГО СИДЕНИЯ" },
        "PBU": { en: "DRIVER SEAT MASSAGE", ru: "МАССАЖ ВОДИТЕЛЬСКОГО СИДЕНЬЯ" },
        "PBV": { en: "PASSENGER SEAT COOLING", ru: "ОХЛАЖДЕНИЕ ПАССАЖИРСКОГО СИДЕНИЯ" },
        "PBT": { en: "DRIVER SEAT COOLING", ru: "ОХЛАЖДЕНИЕ СИДЕНЬЯ ВОДИТЕЛЯ" },
        "ZA4": { en: "ELECTRIC LANGUAGE", ru: "ЯЗЫК ГОЛОСОВОГО АССИСТЕНТА" }
    };

    let currentLang = 'en';

    const configMap = {
        "AAA": "[0][7:0]", "PAS": "[1][2:0]", "VAA": "[1][7:3]", "TBV": "[2][3:0]", "DAA": "[2][7:4]",
        "EAA": "[3][7:0]", "CAL": "[4][1:0]", "AAC": "[4][5:2]", "BAA": "[4][7:6]", "KAG": "[5][7:0]",
        "ZE0": "[6][7:0]", "PAA": "[7][5:0]", "KAJ": "[7][7:6]", "TAA": "[8][2:0]", "PAT": "[8][5:3]",
        "SAF": "[8][7:6]", "SAA": "[9][3:0]", "RAB": "[9][7:4]", "TAT": "[10][3:0]", "SAQ": "[10][7:4]",
        "TAU": "[11][2:0]", "TAB": "[11][5:3]", "TAS": "[11][7:6]", "TAQ": "[12][3:0]", "TBK": "[12][5:4]",
        "TBA": "[12][7:6]", "UAC": "[13][1:0]", "UAB": "[13][7:2]", "VAQ": "[14][1:0]", "VAM": "[14][3:2]",
        "VAL": "[14][5:4]", "TAR": "[14][7:6]", "VAR": "[15][3:0]", "TBU": "[15][5:4]", "ZF4": "[15][7:6]",
        "TBR": "[16][1:0]", "PAP": "[16][4:2]", "VAJ": "[16][7:5]", "TBW": "[17][1:0]", "HAJ": "[17][4:2]",
        "PAE": "[17][7:5]", "LAA": "[18][2:0]", "VAF": "[18][7:3]", "ZA3": "[19][3:0]", "ZA2": "[19][7:4]",
        "TAW": "[20][1:0]", "KAQ": "[20][4:2]", "TAM": "[20][7:5]", "UAH": "[21][1:0]", "NAF": "[21][5:2]",
        "ZC2": "[21][7:6]", "TCR": "[22][1:0]", "ZA0": "[22][3:2]", "RAE": "[22][5:4]", "ZB3": "[22][7:6]",
        "ZF5": "[23][1:0]", "VAG": "[23][4:2]", "KAT": "[23][7:5]", "ZE2": "[24][3:0]", "TBG": "[24][7:4]",
        "FAA": "[25][1:0]", "CBC": "[25][3:2]", "ZA5": "[25][7:4]", "ZB6": "[26][1:0]", "ZB7": "[26][4:2]",
        "HAE": "[26][7:5]", "TBQ": "[27][3:0]", "BAB": "[27][7:4]", "UAG": "[28][1:0]", "TBH": "[28][4:2]",
        "TCD": "[28][7:5]", "MAE": "[29][2:0]", "SAK": "[29][4:3]", "TCE": "[29][7:5]", "BAF": "[30][7:0]",
        "TAY": "[31][1:0]", "ZD5": "[31][3:2]", "KAN": "[31][7:4]", "TCF": "[32][1:0]", "ZG3": "[32][3:2]",
        "ZG2": "[32][7:4]", "HAT": "[33][1:0]", "MAG": "[33][4:2]", "MAF": "[33][7:5]", "TCA": "[34][2:0]",
        "EAM": "[34][4:3]", "ZF6": "[34][7:5]", "FAM": "[35][0:0]", "TCQ": "[35][2:1]", "ZC3": "[35][4:3]",
        "ZH1": "[35][6:5]", "ZG8": "[35][7:7]", "FAJ": "[36][1:0]", "TCP": "[36][3:2]", "ZH3": "[36][5:4]",
        "TEU": "[36][6:6]", "ZQ1": "[36][7:7]", "TAJ": "[37][1:0]", "ZC0": "[37][3:2]", "KAU": "[37][7:4]",
        "EAN": "[38][1:0]", "BAE": "[38][7:2]", "TDL": "[39][1:0]", "MAK": "[39][4:2]", "TDE": "[39][7:5]",
        "PAB": "[40][3:0]", "HAQ": "[40][5:4]", "TBM": "[40][7:6]", "TDM": "[41][1:0]", "ZJ0": "[41][4:2]",
        "FAD": "[41][7:5]", "ZAP": "[42][1:0]", "ZZ4": "[42][4:2]", "VHK": "[42][7:5]", "ZP9": "[43][1:0]",
        "PAV": "[43][3:2]", "MAT": "[43][5:4]", "YBZ": "[43][7:6]", "ZW2": "[44][3:0]", "ZW3": "[44][7:4]",
        "ZG0": "[45][3:0]", "ZAN": "[45][7:4]", "SAG": "[46][1:0]", "ZY1": "[46][3:2]", "ZP6": "[46][5:4]",
        "ZW9": "[46][7:6]", "ZM2": "[47][7:0]", "TAN": "[48][3:0]", "ZK6": "[48][7:4]", "ZL3": "[49][1:0]",
        "MAL": "[49][3:2]", "TGK": "[49][7:4]", "ZJ9": "[50][3:0]", "ZR2": "[50][7:4]", "MAD": "[51][3:0]",
        "ZW8": "[51][5:4]", "ZE4": "[51][7:6]", "CCZ": "[52][3:0]", "ZA9": "[52][7:4]", "AAE": "[53][7:0]",
        "PBW": "[54][1:0]", "PBU": "[54][3:2]", "PBV": "[54][5:4]", "PBT": "[54][7:6]", "ZEN": "[55][1:0]",
        "VCD": "[55][3:2]", "SBB": "[55][7:4]", "ZQ3": "[56][7:4]", "ZA4": "[60][3:0]"
    };

    let currentBytes = [];
    let parsedRules = {};

    function changeLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];

        document.body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerText = t[key];
        });

        document.getElementById('searchBox').placeholder = t.search_placeholder;

        const err = document.getElementById('errorMsg');
        if (err.style.display === 'block') err.innerText = t.error_short;

        updateGridDescriptions();
    }

    function updateGridDescriptions() {
        const items = document.getElementsByClassName('control-item');
        if (items.length === 0) return;

        const keys = Object.keys(configMap).sort();
        keys.forEach(key => {
            const descSpan = document.getElementById(`desc_${key}`);
            if (descSpan) {
                descSpan.innerText = getDesc(key);
            }
        });
    }

    function getDesc(key) {
        if (!paramDesc[key]) return "";
        let val = "";
        if (currentLang === 'ru') {
            val = paramDesc[key].ru;
        } else {
            val = paramDesc[key].en;
        }
        return val || "";
    }

    function cleanHex(str) {
        return str.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
    }

    function hexToBytes(hex) {
        const bytes = [];
        for (let c = 0; c < hex.length; c += 2) {
            bytes.push(parseInt(hex.substr(c, 2), 16));
        }
        return bytes;
    }

    function bytesToHex(bytes) {
        return bytes.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join('');
    }

    function parseLogic(key, logicStr) {
        const match = logicStr.match(/\[(\d+)\]\[(\d+):(\d+)\]/);
        if (!match) return null;

        const byteIdx = parseInt(match[1]);
        const highBit = parseInt(match[2]);
        const lowBit = parseInt(match[3]);
        
        const width = highBit - lowBit + 1;
        const mask = (1 << width) - 1;

        return {
            key: key,
            byteIdx: byteIdx,
            shift: lowBit,
            mask: mask << lowBit,
            rawMask: mask,
            maxVal: mask // Fixed variable name here
        };
    }

    function loadConfig() {
        try {
            const inputField = document.getElementById('inputHex');
            const errorMsg = document.getElementById('errorMsg');
            const grid = document.getElementById('editorGrid');
            
            const rawHex = cleanHex(inputField.value);
            
            if (rawHex.length < 10) {
                errorMsg.innerText = translations[currentLang].error_short;
                errorMsg.style.display = "block";
                return;
            }
            errorMsg.style.display = "none";

            currentBytes = hexToBytes(rawHex);
            grid.innerHTML = ''; 

            const keys = Object.keys(configMap).sort(); 
            
            keys.forEach(key => {
                const rule = parseLogic(key, configMap[key]);
                if(!rule) return; // Skip broken rules safely
                
                parsedRules[key] = rule;

                let currentVal = 0;
                // Safe access to byte array
                if (currentBytes[rule.byteIdx] !== undefined) {
                    currentVal = (currentBytes[rule.byteIdx] & rule.mask) >> rule.shift;
                }

                const description = getDesc(key);

                const div = document.createElement('div');
                div.className = 'control-item';
                div.innerHTML = `
                    <div class="control-header">
                        <span class="param-label">${key}</span>
                        <span class="meta">[${rule.byteIdx}][${rule.shift + (rule.rawMask.toString(2).length -1)}:${rule.shift}]</span>
                    </div>
                    <span class="param-desc" id="desc_${key}">${description}</span>
                    <input type="number" 
                        id="param_${key}" 
                        value="${currentVal}" 
                        min="0" 
                        max="${rule.maxVal}" 
                        oninput="updateValue('${key}')">
                `;
                grid.appendChild(div);
            });

            generateOutput();

        } catch (e) {
            alert("Error parsing config: " + e.message);
            console.error(e);
        }
    }

    function updateValue(key) {
        const rule = parsedRules[key];
        const input = document.getElementById(`param_${key}`);
        let newVal = parseInt(input.value);

        if (isNaN(newVal)) newVal = 0;
        
        if (newVal > rule.maxVal) {
            newVal = rule.maxVal;
            input.value = newVal;
        }
        if (newVal < 0) newVal = 0;

        if (currentBytes.length <= rule.byteIdx) {
            while(currentBytes.length <= rule.byteIdx) currentBytes.push(0);
        }

        const clearMask = ~rule.mask;
        currentBytes[rule.byteIdx] &= clearMask;
        currentBytes[rule.byteIdx] |= (newVal << rule.shift);

        generateOutput();
    }

    function generateOutput() {
        const hex = bytesToHex(currentBytes);
        document.getElementById('outputHex').value = hex;
        document.getElementById('outputLen').innerText = hex.length;
    }

    function copyOutput() {
        const copyText = document.getElementById("outputHex");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value);
        
        const btn = document.querySelector('button.secondary');
        const originalText = translations[currentLang].btn_copy;
        btn.innerText = translations[currentLang].btn_copied;
        setTimeout(() => btn.innerText = originalText, 1500);
    }

    function filterParams() {
        const filter = document.getElementById('searchBox').value.toUpperCase();
        const items = document.getElementsByClassName('control-item');
        for (let i = 0; i < items.length; i++) {
            const textContent = items[i].innerText.toUpperCase();
            if (textContent.indexOf(filter) > -1) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    }

    document.getElementById('inputHex').addEventListener('input', function() {
        const clean = cleanHex(this.value);
        document.getElementById('inputLen').innerText = clean.length;
    });

</script>

</body>
</html>
